#!/usr/bin/env python3
#

import re
import sys
from argparse import ArgumentParser
from urllib.request import urlopen

from bs4 import BeautifulSoup as bs

SELECTOR = "body div.puzzles ul.crossList li.crossword div.tile-info > div"
SUPPORTED_PUZZLES = {"tdb": "tdb", "nymag": "nymag", "vox": "vox", "tny": "tny-weekly"}

args_parser = ArgumentParser()
args_parser.add_argument(
    "puz_source",
    choices=tuple(SUPPORTED_PUZZLES.keys()),
    help="The source of the puzzle",
)
args_parser.add_argument(
    "subtitle_string", help="A string to match in the puzzle description"
)
args = args_parser.parse_args()

source = args.puz_source
source_set = SUPPORTED_PUZZLES[source]

html = (
    urlopen(
        "https://cdn3.amuselabs.com/{source}/date-picker?set={source_set}&limit=100".format(
            source=source, source_set=source_set
        )
    )
    .read()
    .decode()
)
soup = bs(html, features="html.parser")

try:
    xword_id = next(
        filter(
            lambda s: re.search(r"\b{}\b".format(args.subtitle_string), s.getText(),),
            soup.select(SELECTOR),
        )
    ).parent.parent.parent["data-id"]
except StopIteration:
    sys.exit("No puzzle found for string [{}]!".format(args.subtitle_string))

print(
    "https://cdn3.amuselabs.com/{source}/crossword?id={id}&set={source_set}".format(
        source=source, id=xword_id, source_set=source_set
    )
)
